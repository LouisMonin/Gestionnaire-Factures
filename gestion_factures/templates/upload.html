<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Importer une facture - FactuPro</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="upload-page">
  {% include 'header.html' %}

  <div class="container upload">
    <h1>Importer une facture</h1>

    <div class="flex-container" style="display: flex; gap: 60px; justify-content: space-between;">
      <div id="preview" class="upload-preview" style="flex:1;"></div>

      <form id="facture-formulaire" class="facture-form" method="POST" style="display:none; flex:1;">
        <h3>üìù Informations extraites</h3>
        <label>Nom entreprise : <input type="text" name="nom_entreprise" id="nom_entreprise"></label>
        <label>Num√©ro de client : <input type="text" name="numero_client" id="numero_client"></label>
        <label>Num√©ro de facture : <input type="text" name="numero_facture" id="numero_facture"></label>
        <label>Date de facture : <input type="date" name="date_facture" id="date_facture"></label>
        <label>√âch√©ance : <input type="date" name="echeance" id="echeance"></label>
        <label>TVA (%) : <input type="text" name="tva" id="tva"></label>
        <label>Total TTC : <input type="text" name="total_ttc" id="total_ttc"></label>
        <label>Somme finale √† payer : <input type="text" name="somme_finale" id="somme_finale"></label>
        <label><input type="checkbox" name="checkbox_paiement" id="checkbox_paiement"> Facture pay√©e</label>
        <input type="hidden" name="nom_fichier" id="nom_fichier">
        <button type="submit">‚úÖ Valider la facture</button>
      </form>
    </div>

    <form class="upload-form">
      <input type="file" id="facture" name="facture" accept=".pdf,.png,.jpg,.jpeg,.csv,.xls,.xlsx" required>
    </form>

    <div style="text-align:center">
      <a class="button return-home" href="/">‚¨Ö Retour √† l'accueil</a>
    </div>
  </div>

  <footer class="footer">
    <p>&copy; 2025 FactuPro ‚Äî Tous droits r√©serv√©s</p>
  </footer>

<script>
document.getElementById('facture').addEventListener('change', function () {
  const file = this.files[0];
  const preview = document.getElementById('preview');
  const form = document.getElementById('facture-formulaire');

  preview.innerHTML = '';
  form.style.display = 'none';
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function (e) {
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, { type: 'array' });
    const sheet = workbook.Sheets[workbook.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, raw: false });

    // Affichage tableau
    let table = '<table>';
    rows.forEach(row => {
      table += '<tr>' + row.map(cell => `<td>${cell || ''}</td>`).join('') + '</tr>';
    });
    table += '</table>';
    preview.innerHTML = table;

    const normalize = str => (str || '').toString().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/[^a-z0-9]/gi, '').toLowerCase();
    const cleanValue = val => (val || '').replace(/[^\d.,]/g, '').replace(',', '.').trim();

    const flatMap = {};
    rows.forEach(row => {
      for (let i = 0; i < row.length; i++) {
        const current = String(row[i] || '').trim();
        const keyNorm = normalize(current);

        if (current.includes(':')) {
          const [keyRaw, ...rest] = current.split(':');
          const key = normalize(keyRaw);
          let val = rest.join(':').trim();
          if (!val) {
            for (let j = i + 1; j < row.length; j++) {
              if (String(row[j]).trim()) {
                val = String(row[j]).trim();
                break;
              }
            }
          }
          flatMap[key] = val;
        } else if (keyNorm && row[i + 1]) {
          const val = String(row[i + 1]).trim();
          if (val) flatMap[keyNorm] = val;
        }
      }
    });

    const findValue = (labels) => {
      for (let key in flatMap) {
        for (let label of labels) {
          if (key.includes(normalize(label))) return flatMap[key];
        }
      }
      return '';
    };

    const formatDate = value => {
      const num = parseFloat(value);
      if (!isNaN(num) && num > 40000) {
        const date = new Date((num - 25569) * 86400 * 1000);
        return date.toISOString().split('T')[0];
      }
      const tryDate = new Date(value);
      if (!isNaN(tryDate)) return tryDate.toISOString().split('T')[0];
      if (typeof value === 'string' && value.match(/\d{1,2}\/\d{1,2}\/\d{2,4}/)) {
        const [d, m, y] = value.split('/');
        return `${y.length === 2 ? '20' + y : y}-${m.padStart(2, '0')}-${d.padStart(2, '0')}`;
      }
      return '';
    };

    document.getElementById("nom_entreprise").value = findValue(["nom entreprise", "nomentreprise"]);
    document.getElementById("numero_client").value = findValue(["numero de client", "client"]);
    document.getElementById("numero_facture").value = findValue(["numero de facture", "facture"]);
    document.getElementById("date_facture").value = formatDate(findValue(["date de facture", "datedefacture"]));
    document.getElementById("echeance").value = formatDate(findValue(["echeance", "echeance de paiement"]));
    document.getElementById("tva").value = cleanValue(findValue(["taux de tva", "tauxtva", "tva"]));
    document.getElementById("total_ttc").value = cleanValue(findValue(["total ttc", "totalttc"]));
    document.getElementById("somme_finale").value = cleanValue(findValue(["somme finale", "total a payer", "sommefinaleapayer"]));
    document.getElementById("nom_fichier").value = file.name;

    // Fallback DOM robuste
    const fallbackFromDOM = (label, fieldId) => {
      if (!document.getElementById(fieldId).value) {
        const cells = [...document.querySelectorAll('#preview td')];
        for (let i = 0; i < cells.length; i++) {
          const text = cells[i].textContent.toLowerCase().trim();
          if (text.includes(label.toLowerCase())) {
            for (let j = 1; j <= 5; j++) {
              const nextCell = cells[i + j];
              if (nextCell) {
                const val = nextCell.textContent.trim().replace(/[^\d.,]/g, '').replace(',', '.');
                if (val) {
                  document.getElementById(fieldId).value = val;
                  return;
                }
              }
            }
          }
        }
      }
    };

    fallbackFromDOM("taux de tva", "tva");
    fallbackFromDOM("total ttc", "total_ttc");
    fallbackFromDOM("somme finale", "somme_finale");

    form.style.display = 'block';
  };

  reader.readAsArrayBuffer(file);
});
</script>
</body>
</html>
