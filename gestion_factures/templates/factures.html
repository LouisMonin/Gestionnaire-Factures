<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Factures enregistrées</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>
<body>
    {% include 'header.html' %}


    

    <div class="container">
        <h1>Liste des factures</h1>

        <button type="button" onclick="location.reload();">Réinitialiser les filtres</button>


        <table id = "table-factures">
          <thead>
            <tr>
                <th>ID</th>
                <th>Entreprise <br><input type="text" placeholder="Filtrer Entreprise" class="filter-input" data-col="1"></th>
                <th>Libellé <br><input type="text" placeholder="Filtrer Libellé" class="filter-input" data-col="2"></th>                
                <th>Date facture</th>
                <th>Échéance</th>
                <th>TVA</th>
                <th>Total TTC</th>
                <th>Payée <br>
                  <select id="filter-paid" title="Filtrer les factures payées" data-col="7" style="text-align: center; text-align-last: center;"> 
                    <option value="toutes">Toutes</option>
                    <option value="payee">Payée</option>
                    <option value="impayee">Non payée</option>
                  </select>
                </th>


                <th>
                  Catégorisation <br>
                  <select class="filter-input" data-col="8" style="text-align: center; text-align-last: center;">
                    <option value="">Toutes</option> <!-- Option vide pour ne pas filtrer -->
                    {% for cat in categories %}
                      <option value="{{ cat }}">{{ cat }}</option>
                    {% endfor %}
                  </select>
                </th>            
                
                <th>Supprimer</th>
            </tr>
          </thead>
          </tr>

        
            {% for f in factures %}
            <tr>
                <td>
                    {% if f['nom_fichier'] %}
                      <a href="{{ url_for('telecharger_fichier', filename=f['nom_fichier']) }}" target="_blank" title="Télécharger la facture {{ f['id'] }}">
                        {{ f['id'] }}
                      </a>
                    {% else %}
                      {{ f['id'] }}
                    {% endif %}
                  </td>

                <td>{{ f['fournisseur'] }}</td>
                <td>{{ f['numero_facture'] }}</td>
                <td>{{ f['date_facture'] }}</td>
                <td>{{ f['echeance'] }}</td>
                <td>{{ f['TVA'] }} %</td>
                <td>{{ f['montant_total'] }} €</td>
                <td>
                    <form action="{{ url_for('toggle_payee', facture_id=f['id']) }}" method="post">
                        <input type="checkbox" name="checkbox_paiement" {% if f['facture_payee'] == 1 %}checked{% endif %} onchange="this.form.submit()">
                    </form>
                  </td>

<td class="categorie-cell {{ f['categorie']|lower|replace(' ', '_')|replace('é', 'e')|replace('-', '_') }}">
    <form method="POST" action="{{ url_for('modifier_categorie', facture_id=f['id']) }}">
      <select name="categorie" onchange="this.form.submit()">
        {% for cat in categories %}
          <option value="{{ cat }}" {% if f['categorie'] == cat %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
      </select>
    </form>
  </td>
                <td>
                    <form method="POST" action="/supprimer/{{ f['id'] }}" onsubmit="return confirm('Confirmer la suppression ?');">
                        <button type="submit" class="danger">X</button>
                    </form>
                </td>
                
            </tr>
            {% endfor %}

            <script>
              document.addEventListener('DOMContentLoaded', function () {
                const table = document.getElementById('table-factures');
                const rows = table.tBodies[0].rows;
                const textFilters = document.querySelectorAll('.filter-input');
                const paidFilter = document.getElementById('filter-paid');
              
                const noResultRow = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = table.rows[0].cells.length;
                td.style.textAlign = 'center';
                td.textContent = 'Aucune facture';
                noResultRow.appendChild(td);
                noResultRow.style.display = 'none';
                table.tBodies[0].appendChild(noResultRow);
              
                function appliquerFiltres() {
                  let visibleCount = 0;
              
                  for (let row of rows) {
                    if (row === noResultRow) continue;
              
                    let visible = true;
              
                    // Filtres texte
                    textFilters.forEach(input => {
                      const col = parseInt(input.dataset.col);
                      const cell = row.cells[col];
                      let cellText = '';
              
                      const select = cell.querySelector('select');
                      if (select) {
                        cellText = select.value.toLowerCase();
                      } else {
                        cellText = cell.textContent.toLowerCase();
                      }
              
                      if (input.value && !cellText.includes(input.value.toLowerCase())) {
                        visible = false;
                      }
                    });
              
                    // Filtre payée
                    const checkbox = row.cells[7].querySelector('input[type="checkbox"]');
                    const payeeVal = paidFilter.value;
                    const estPayee = checkbox.checked;
              
                    if (payeeVal === 'payee' && !estPayee) visible = false;
                    if (payeeVal === 'impayee' && estPayee) visible = false;
              
                    row.style.display = visible ? '' : 'none';
                    if (visible) visibleCount++;
                  }
              
                  noResultRow.style.display = visibleCount === 0 ? '' : 'none';
                }
              
                // Écouteurs
                textFilters.forEach(input => input.addEventListener('input', appliquerFiltres));
                paidFilter.addEventListener('change', appliquerFiltres);
              });
              </script>

        </table>

        <form method="POST" action="/supprimer_tout" onsubmit="return confirm('Supprimer toutes les factures ?');">
            <button type="submit" class="danger full">Supprimer toutes les factures</button>
        </form>

        <div style="text-align:center">
            <a class="button" href="/">⬅ Retour à l'accueil</a>
        </div>
    </div>

    <footer class="footer">
        <p>&copy; 2025 FactuPro — Tous droits réservés</p>
    </footer>

</body>
</html>
